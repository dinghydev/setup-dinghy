name: 'Setup Dinghy'
description: 'Setup Dinghy for use in GitHub Actions workflows'

inputs:
  prepare-images:
    description: 'list of images to prepare in advance'
    required: false
    default: 'release'

outputs:
  dinghy-version:
    description: 'The version of Dinghy CLI that was installed'
    value: ${{ steps.install-dinghy-cli.outputs.dinghy-version }}

runs:
  using: 'composite'
  steps:
    - name: Install Dinghy CLI
      id: install-dinghy-cli
      shell: bash
      run: |
        echo "::group::Install Dinghy CLI"
        if [ -z "$DINGHY_VERSION" ]; then
          DINGHY_VERSION="${DINGHY_CLI_VERSION:-latest}"
          if [ "$DINGHY_VERSION" = "latest" ]; then
            DINGHYRC="${APP_HOME:-.}/.dinghyrc"
            if [ -f "$DINGHYRC" ]; then
              while IFS= read -r line || [ -n "$line" ]; do
                case "$line" in
                  DINGHY_ENGINE_VERSION=*)
                    DINGHY_VERSION="${line#DINGHY_ENGINE_VERSION=}"
                    break
                    ;;
                esac
              done < "$DINGHYRC"
            fi  
            if [ "$DINGHY_VERSION" != "latest" ]; then
              export DINGHY_VERSION="$DINGHY_VERSION"
            fi
          fi
        fi
        curl -fsSL "https://get.dinghy.dev/install.sh?source=github-action&version=$DINGHY_VERSION" | sh
        export PATH="$HOME/.dinghy/bin:$PATH"
        echo "::endgroup::"
        
        echo "::group::Prepare Images"
        PREPARE_IMAGES="${{ inputs.prepare-images }}"
        dinghy docker cache --include-images $PREPARE_IMAGES
        echo "::endgroup::"
        
        echo "::group::Prepare Workflow"
        dinghy gh prepare
        echo "::endgroup::"

